{% extends 'scheduler/base.html' %}
{% load static %}

{% block title %}Assignments{% endblock %}

{% block extra_css %}
<style>
/* Mobile-responsive assignment list styles */
@media (max-width: 768px) {
    .btn-group {
        flex-direction: column;
        width: 100%;
    }
    
    .btn-group .btn {
        margin-bottom: 0.25rem;
        border-radius: 0.375rem !important;
    }
    
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .badge {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
    }
    
    /* Hide less important columns on mobile */
    .d-none-mobile {
        display: none !important;
    }
    
    /* Stack filter controls */
    .filter-controls {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .filter-controls .btn {
        width: 100%;
    }
}

@media (max-width: 576px) {
    .table td, .table th {
        padding: 0.375rem 0.25rem;
        font-size: 0.8rem;
    }
    
    .btn-sm {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    /* Compact header */
    h1 {
        font-size: 1.5rem;
    }
}

/* Touch-friendly action buttons */
.action-buttons .btn {
    min-height: 36px;
    margin: 0.125rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1><i class="bi bi-clipboard-check"></i> Assignments{% if selected_event %} - {{ selected_event.name }}{% endif %}</h1>
                    {% if selected_event and not show_all_events %}
                        <div class="d-flex align-items-center gap-2 mt-2">
                            <span class="badge bg-primary">{{ selected_event.name }}</span>
                            <a href="?show_all=true" class="btn btn-sm btn-outline-secondary">
                                <i class="bi bi-eye"></i> View All Events
                            </a>
                        </div>
                    {% elif show_all_events %}
                        <div class="d-flex align-items-center gap-2 mt-2">
                            <span class="badge bg-secondary">All Events</span>
                        </div>
                    {% endif %}
                </div>
                <div class="btn-group" role="group">
                    {% if selected_event %}
                        <a href="{% url 'scheduler:event_detail' selected_event.id %}#auto-assign" class="btn btn-primary">
                            <i class="bi bi-magic"></i> <span class="d-none d-md-inline">Auto-Assign</span>
                        </a>
                    {% endif %}
                    <a href="{% url 'scheduler:assignment_create' %}" class="btn btn-outline-primary">
                        <i class="bi bi-plus-circle"></i> <span class="d-none d-md-inline">New Assignment</span>
                    </a>
                    <a href="{% url 'scheduler:bulk_assignment_create' %}" class="btn btn-success">
                        <i class="bi bi-plus-square"></i> <span class="d-none d-md-inline">Bulk Create</span>
                    </a>
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-download"></i> <span class="d-none d-md-inline">Export</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{% url 'scheduler:export_assignments' %}?format=csv">
                                <i class="bi bi-filetype-csv"></i> Export as CSV
                            </a></li>
                            <li><a class="dropdown-item" href="{% url 'scheduler:export_assignments' %}?format=excel">
                                <i class="bi bi-filetype-xlsx"></i> Export as Excel
                            </a></li>
                            <li><a class="dropdown-item" href="{% url 'scheduler:export_assignments' %}?format=pdf">
                                <i class="bi bi-filetype-pdf"></i> Export as PDF
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-3">
                            <label for="search" class="form-label">Search</label>
                            <input type="text" class="form-control" id="search" name="search" 
                                   value="{{ search_query }}" placeholder="Attendant name, position...">
                        </div>
                        <div class="col-md-2">
                            <label for="event" class="form-label">Event</label>
                            <select class="form-select" id="event" name="event">
                                <option value="">All Events</option>
                                {% for event in events %}
                                    <option value="{{ event.id }}" {% if event_filter == event.id|stringformat:"s" %}selected{% endif %}>
                                        {{ event.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="attendant" class="form-label">Attendant</label>
                            <select class="form-select" id="attendant" name="attendant">
                                <option value="">All Attendants</option>
                                {% for attendant in attendants %}
                                    <option value="{{ attendant.id }}" {% if attendant_filter == attendant.id|stringformat:"s" %}selected{% endif %}>
                                        {{ attendant.get_full_name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="position" class="form-label">Position</label>
                            <input type="text" class="form-control" id="position" name="position" 
                                   value="{{ position_filter }}" placeholder="Cart, Literature...">
                        </div>
                        <div class="col-md-3">
                            <label for="date_range" class="form-label">Date Range</label>
                            <select class="form-select" name="date_range">
                                <option value="">All Dates</option>
                                <option value="today" {% if date_range_filter == 'today' %}selected{% endif %}>Today</option>
                                <option value="this_week" {% if date_range_filter == 'this_week' %}selected{% endif %}>This Week</option>
                                <option value="this_month" {% if date_range_filter == 'this_month' %}selected{% endif %}>This Month</option>
                                <option value="upcoming" {% if date_range_filter == 'upcoming' %}selected{% endif %}>Upcoming</option>
                            </select>
                        </div>
                        <div class="col-md-12">
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-search"></i> Search & Filter
                                </button>
                                <a href="{% url 'scheduler:assignment_list' %}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-clockwise"></i> Clear
                                </a>
                                <button type="button" class="btn btn-outline-info" onclick="toggleAssignmentAdvancedFilters()">
                                    <i class="bi bi-funnel"></i> Advanced Filters
                                </button>
                            </div>
                        </div>
                    </form>
                    
                    <!-- Advanced Filters -->
                    <div id="assignmentAdvancedFilters" class="mt-3" style="display: none;">
                        <form method="get" class="row g-3">
                            <!-- Preserve existing filters -->
                            <input type="hidden" name="search" value="{{ search_query }}">
                            <input type="hidden" name="event" value="{{ event_filter }}">
                            <input type="hidden" name="attendant" value="{{ attendant_filter }}">
                            <input type="hidden" name="position" value="{{ position_filter }}">
                            <input type="hidden" name="date_range" value="{{ date_range_filter }}">
                            
                            <div class="col-md-3">
                                <label for="has_notes" class="form-label">Has Notes</label>
                                <select class="form-select" name="has_notes">
                                    <option value="">All</option>
                                    <option value="yes" {% if has_notes_filter == 'yes' %}selected{% endif %}>Yes</option>
                                    <option value="no" {% if has_notes_filter == 'no' %}selected{% endif %}>No</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="shift_duration" class="form-label">Min Duration (hours)</label>
                                <input type="number" class="form-control" name="shift_duration" 
                                       value="{{ shift_duration_filter }}" placeholder="0" step="0.5">
                            </div>
                            <div class="col-md-3">
                                <label for="created_after" class="form-label">Created After</label>
                                <input type="date" class="form-control" name="created_after" 
                                       value="{{ created_after_filter }}">
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-success mt-4">
                                    <i class="bi bi-funnel-fill"></i> Apply Advanced Filters
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
function toggleAssignmentAdvancedFilters() {
    const filters = document.getElementById('assignmentAdvancedFilters');
    if (filters.style.display === 'none') {
        filters.style.display = 'block';
    } else {
        filters.style.display = 'none';
    }
}
</script>

    <!-- Assignments Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    {% if page_obj %}
                    <!-- Bulk Actions -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleSelectAll()">
                                <i class="fas fa-check-square"></i> Select All
                            </button>
                            <span class="ms-2 text-muted" id="selectedCount">0 selected</span>
                        </div>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-success" onclick="bulkCreate()">
                                <i class="fas fa-plus-circle"></i> Bulk Create
                            </button>
                            <button type="button" class="btn btn-sm btn-warning" onclick="bulkUpdate()" disabled id="bulkUpdateBtn">
                                <i class="fas fa-edit"></i> Bulk Update
                            </button>
                            <button type="button" class="btn btn-sm btn-danger" onclick="bulkDelete()" disabled id="bulkDeleteBtn">
                                <i class="fas fa-trash-alt"></i> Bulk Delete
                            </button>
                        </div>
                    </div>

                    <form id="bulkForm" method="post">
                        {% csrf_token %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th width="40">
                                            <input type="checkbox" class="form-check-input" id="selectAllCheckbox">
                                        </th>
                                        <th>Attendant</th>
                                        <th>Event</th>
                                        <th>Position</th>
                                        <th>Shift Time</th>
                                        <th>Duration</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for assignment in page_obj %}
                                    <tr>
                                        <td>
                                            <input type="checkbox" class="form-check-input assignment-checkbox" 
                                                   name="assignment_ids" value="{{ assignment.id }}">
                                        </td>
                                        <td>
                                            <a href="{% url 'scheduler:attendant_detail' assignment.attendant.id %}">
                                                {{ assignment.attendant.get_full_name }}
                                            </a>
                                        </td>
                                        <td>
                                            <a href="{% url 'scheduler:event_detail' assignment.event.id %}">
                                                {{ assignment.event.name }}
                                            </a>
                                        </td>
                                        <td>{{ assignment.position }}</td>
                                        <td>
                                            {{ assignment.shift_start|date:"M d, Y H:i" }} - 
                                            {{ assignment.shift_end|date:"H:i" }}
                                        </td>
                                        <td>{{ assignment.get_duration_hours }} hours</td>
                                        <td>
                                            <a href="{% url 'scheduler:assignment_edit' assignment.id %}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-edit"></i> Edit
                                            </a>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="7" class="text-center text-muted">No assignments found.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </form>

<script>
document.addEventListener('DOMContentLoaded', function() {
    updateSelectedCount();
    
    // Add event listeners to checkboxes
    document.querySelectorAll('.assignment-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedCount);
    });
    
    // Select all checkbox functionality
    document.getElementById('selectAllCheckbox').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.assignment-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
        updateSelectedCount();
    });
});

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    selectAllCheckbox.checked = !selectAllCheckbox.checked;
    selectAllCheckbox.dispatchEvent(new Event('change'));
}

function updateSelectedCount() {
    const selectedCount = document.querySelectorAll('.assignment-checkbox:checked').length;
    document.getElementById('selectedCount').textContent = `${selectedCount} selected`;
    
    // Enable/disable bulk action buttons
    const bulkUpdateBtn = document.getElementById('bulkUpdateBtn');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    
    if (selectedCount > 0) {
        bulkUpdateBtn.disabled = false;
        bulkDeleteBtn.disabled = false;
    } else {
        bulkUpdateBtn.disabled = true;
        bulkDeleteBtn.disabled = true;
    }
}

function bulkCreate() {
    window.location.href = '{% url "scheduler:bulk_assignment_create" %}';
}

function bulkUpdate() {
    const form = document.getElementById('bulkForm');
    form.action = '{% url "scheduler:bulk_assignment_update" %}';
    form.submit();
}

function bulkDelete() {
    const selectedCount = document.querySelectorAll('.assignment-checkbox:checked').length;
    if (selectedCount === 0) {
        alert('Please select assignments to delete.');
        return;
    }
    
    if (confirm(`Are you sure you want to delete ${selectedCount} assignment(s)?`)) {
        const form = document.getElementById('bulkForm');
        form.action = '{% url "scheduler:bulk_assignment_delete" %}';
        form.submit();
    }
}
</script>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if page_obj.has_other_pages %}
                    <nav aria-label="Assignments pagination">
                        <ul class="pagination justify-content-center">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% if event_filter %}event={{ event_filter }}&{% endif %}{% if position_filter %}position={{ position_filter }}&{% endif %}{% if date_from %}date_from={{ date_from }}&{% endif %}{% if date_to %}date_to={{ date_to }}&{% endif %}page={{ page_obj.previous_page_number }}">Previous</a>
                                </li>
                            {% endif %}

                            {% for num in page_obj.paginator.page_range %}
                                {% if page_obj.number == num %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ num }}</span>
                                    </li>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?{% if event_filter %}event={{ event_filter }}&{% endif %}{% if position_filter %}position={{ position_filter }}&{% endif %}{% if date_from %}date_from={{ date_from }}&{% endif %}{% if date_to %}date_to={{ date_to }}&{% endif %}page={{ num }}">{{ num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% if event_filter %}event={{ event_filter }}&{% endif %}{% if position_filter %}position={{ position_filter }}&{% endif %}{% if date_from %}date_from={{ date_from }}&{% endif %}{% if date_to %}date_to={{ date_to }}&{% endif %}page={{ page_obj.next_page_number }}">Next</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}

                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">No assignments found</h4>
                        <p class="text-muted">Try adjusting your filters or create a new assignment.</p>
                        {% if user.role == 'admin' or user.role == 'overseer' %}
                        <a href="#" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Create Assignment
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
