{% extends 'scheduler/base.html' %}
{% load static %}

{% block title %}Lanyard Tracking - JW Attendant Scheduler{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css">
<style>
    .lanyard-table {
        font-size: 0.9rem;
    }
    .badge-number {
        font-weight: bold;
        color: #0d6efd;
    }
    .status-checked-out {
        background-color: #fff3cd;
    }
    .status-returned {
        background-color: #d1e7dd;
    }
    .stat-item {
        text-align: center;
    }
    .table th {
        background-color: #f8f9fa;
        border-top: none;
        font-weight: 600;
    }
    
    .card {
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        border: 1px solid rgba(0, 0, 0, 0.125);
    }
    
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid rgba(0, 0, 0, 0.125);
    }
    
    /* Custom attendant search dropdown */
    .attendant-search-container {
        position: relative;
        min-width: 200px;
    }
    
    .attendant-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ced4da;
        border-top: none;
        border-radius: 0 0 0.375rem 0.375rem;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }
    
    .attendant-search {
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        text-align: center !important;
    }
    
    .attendant-search:focus {
        border-color: #86b7fe;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        text-align: center !important;
    }
    
    .attendant-search::placeholder {
        text-align: center !important;
    }
    
    .attendant-dropdown .dropdown-item {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        border-bottom: 1px solid #f8f9fa;
        font-size: 0.875rem;
    }
    
    .attendant-dropdown .dropdown-item:hover {
        background-color: #f8f9fa;
    }
    
    .attendant-dropdown .dropdown-item:last-child {
        border-bottom: none;
    }
    
    .attendant-search:focus + .attendant-dropdown {
        display: block !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    {% csrf_token %}
    <div class="row">
        <div class="col-12">
            <!-- Event Information Header -->
            {% if current_event %}
            <div class="card mb-4">
                <div class="card-header bg-primary text-white text-center">
                    <h2 class="mb-0">Attendant Lanyard Tracking</h2>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="row mb-2">
                                <div class="col-4"><strong>Date:</strong></div>
                                <div class="col-8">{{ current_event.start_date|date:"F j, Y" }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-4"><strong>Event:</strong></div>
                                <div class="col-8">{{ current_event.name }}</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-4"><strong>Location:</strong></div>
                                <div class="col-8">{{ current_event.location|default:"TBD" }}</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="row mb-2">
                                <div class="col-6"><strong>Assembly Overseer:</strong></div>
                                <div class="col-6">_________________________</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6"><strong>Attendant Overseer:</strong></div>
                                <div class="col-6">_________________________</div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6"><strong>Phone:</strong></div>
                                <div class="col-6">_________________________</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-center mb-4">
                <h1 class="h3 mb-0">Attendant Lanyard Tracking</h1>
            </div>
            {% endif %}

            {% if not current_event %}
                <div class="alert alert-warning">
                    <h4>No Active Event</h4>
                    <p>Please create an event with status "Upcoming" or "Current" to track lanyards.</p>
                    <a href="{% url 'scheduler:event_create' %}" class="btn btn-primary">Create Event</a>
                </div>
            {% else %}
                <!-- Statistics Cards -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="stat-item">
                            <div class="stat-number" id="total-assigned">0</div>
                            <div class="stat-label">Assigned</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item">
                            <div class="stat-number" id="total-checked-out">0</div>
                            <div class="stat-label">Checked Out</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item">
                            <div class="stat-number" id="total-returned">0</div>
                            <div class="stat-label">Returned</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="d-grid gap-2">
                            <button class="btn btn-success btn-sm" onclick="exportToPDF()">
                                <i class="bi bi-file-pdf"></i> Export PDF
                            </button>
                            <button class="btn btn-info btn-sm" onclick="emailReport()">
                                <i class="bi bi-envelope"></i> Email Report
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Lanyard Tracking Table -->
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Lanyard Assignments</h5>
                        <small class="text-muted">Total Badges: 100</small>
                    </div>
                    <div class="card-body p-0">
                        <!-- Pagination Controls -->
                        <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                            <div>
                                <label for="entriesPerPage" class="form-label me-2 mb-0">Show:</label>
                                <select id="entriesPerPage" class="form-select form-select-sm d-inline-block" style="width: auto;">
                                    <option value="10">10 entries</option>
                                    <option value="20">20 entries</option>
                                    <option value="50" selected>50 entries</option>
                                    <option value="100">100 entries</option>
                                </select>
                            </div>
                            <div id="paginationInfo" class="text-muted small"></div>
                            <div>
                                <button id="prevPage" class="btn btn-outline-secondary btn-sm me-1" disabled>
                                    <i class="bi bi-chevron-left"></i> Previous
                                </button>
                                <button id="nextPage" class="btn btn-outline-secondary btn-sm">
                                    Next <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover mb-0 table-sm">
                                <thead>
                                    <tr>
                                        <th style="width: 80px;">Badge #</th>
                                        <th style="width: 250px;" class="text-center">Attendant Name</th>
                                        <th style="width: 130px;">Phone Number</th>
                                        <th style="width: 90px;" class="text-center">Checked-out</th>
                                        <th style="width: 90px;" class="text-center">Returned</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for assignment in lanyard_assignments %}
                                        <tr class="{% if assignment.returned %}status-returned{% elif assignment.checked_out %}status-checked-out{% endif %}" 
                                            data-assignment-id="{{ assignment.id }}">
                                            <td class="badge-number">{{ assignment.badge_number }}</td>
                                            <td class="text-center">
                                                <div class="attendant-search-container" data-assignment-id="{{ assignment.id }}">
                                                    <input type="text" 
                                                           class="form-control form-control-sm attendant-search" 
                                                           style="text-align: center !important;"
                                                           placeholder="Type to search attendants..."
                                                           data-assignment-id="{{ assignment.id }}"
                                                           value="{% if assignment.attendant %}{{ assignment.attendant.get_full_name }}{% endif %}"
                                                           autocomplete="off">
                                                    <div class="attendant-dropdown" style="display: none;">
                                                        <div class="dropdown-item" data-value="">Select Attendant...</div>
                                                        {% for attendant in active_attendants %}
                                                            <div class="dropdown-item" 
                                                                 data-value="{{ attendant.id }}" 
                                                                 data-phone="{{ attendant.phone|default:'' }}"
                                                                 {% if assignment.attendant and assignment.attendant.id == attendant.id %}data-selected="true"{% endif %}>
                                                                {{ attendant.get_full_name }}
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </td>
                                            <td class="phone-number">
                                                {% if assignment.attendant %}{{ assignment.attendant.phone }}{% endif %}
                                            </td>
                                            <td class="text-center">
                                                <input type="checkbox" class="form-check-input checkout-checkbox" 
                                                       {% if assignment.checked_out %}checked{% endif %}
                                                       data-assignment-id="{{ assignment.id }}"
                                                       data-action="checkout">
                                            </td>
                                            <td class="text-center">
                                                <input type="checkbox" class="form-check-input return-checkbox" 
                                                       {% if assignment.returned %}checked{% endif %}
                                                       data-assignment-id="{{ assignment.id }}"
                                                       data-action="return">
                                            </td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-4">
                                                No lanyard assignments available. Please ensure there is an active event.
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Summary Section -->
                <div class="row mt-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Lanyard Summary</h6>
                            </div>
                            <div class="card-body">
                                <div class="row mb-2">
                                    <div class="col-8"><strong>Number of Lanyards received by AH:</strong></div>
                                    <div class="col-4">_____________</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-8"><strong>Lanyards returned to AH:</strong></div>
                                    <div class="col-4">_____________</div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-8"><strong>Lanyards to recover and return:</strong></div>
                                    <div class="col-4">_____________</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-info">
                            <h6><strong>Important Note:</strong></h6>
                            <p class="mb-0">If a lanyard is missing please follow through with the attendant and arrange for the missing lanyard to be returned to the Assembly Hall. Please provide a copy of this tracking form to the AH when you return the lanyards.</p>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Pagination variables
let currentPage = 1;
let entriesPerPage = 50;
let totalEntries = 0;
let allRows = [];

// Initialize pagination
function initializePagination() {
    const tbody = document.querySelector('tbody');
    allRows = Array.from(tbody.querySelectorAll('tr[data-assignment-id]'));
    totalEntries = allRows.length;
    
    // Set up event listeners
    document.getElementById('entriesPerPage').addEventListener('change', function() {
        entriesPerPage = parseInt(this.value);
        currentPage = 1;
        displayPage();
    });
    
    document.getElementById('prevPage').addEventListener('click', function() {
        if (currentPage > 1) {
            currentPage--;
            displayPage();
        }
    });
    
    document.getElementById('nextPage').addEventListener('click', function() {
        const totalPages = Math.ceil(totalEntries / entriesPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            displayPage();
        }
    });
    
    displayPage();
}

// Display current page
function displayPage() {
    const startIndex = (currentPage - 1) * entriesPerPage;
    const endIndex = startIndex + entriesPerPage;
    const totalPages = Math.ceil(totalEntries / entriesPerPage);
    
    // Hide all rows
    allRows.forEach(row => row.style.display = 'none');
    
    // Show rows for current page
    for (let i = startIndex; i < endIndex && i < totalEntries; i++) {
        allRows[i].style.display = '';
    }
    
    // Update pagination info
    const showingStart = startIndex + 1;
    const showingEnd = Math.min(endIndex, totalEntries);
    document.getElementById('paginationInfo').textContent = 
        'Showing ' + showingStart + ' to ' + showingEnd + ' of ' + totalEntries + ' entries';
    
    // Update button states
    document.getElementById('prevPage').disabled = currentPage === 1;
    document.getElementById('nextPage').disabled = currentPage === totalPages;
}

// Initialize custom attendant search dropdowns
document.addEventListener('DOMContentLoaded', function() {
    initializePagination();
    updateStats();
    
    // Initialize all attendant search inputs
    document.querySelectorAll('.attendant-search').forEach(input => {
        const container = input.closest('.attendant-search-container');
        const dropdown = container.querySelector('.attendant-dropdown');
        const assignmentId = input.getAttribute('data-assignment-id');
        
        // Show dropdown on focus
        input.addEventListener('focus', function() {
            dropdown.style.display = 'block';
            filterDropdown(input, dropdown);
        });
        
        // Filter dropdown on input
        input.addEventListener('input', function() {
            filterDropdown(input, dropdown);
        });
        
        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!container.contains(e.target)) {
                dropdown.style.display = 'none';
            }
        });
        
        // Handle dropdown item selection
        dropdown.addEventListener('click', function(e) {
            if (e.target.classList.contains('dropdown-item')) {
                const value = e.target.getAttribute('data-value');
                const text = e.target.textContent;
                const phone = e.target.getAttribute('data-phone') || '';
                
                // Clear previous selection markers
                dropdown.querySelectorAll('.dropdown-item').forEach(item => {
                    item.removeAttribute('data-selected');
                });
                
                // Mark new selection
                if (value) {
                    e.target.setAttribute('data-selected', 'true');
                }
                
                input.value = value ? text : '';
                input.style.textAlign = 'center';
                dropdown.style.display = 'none';
                
                // Update phone number immediately
                const row = document.querySelector(`tr[data-assignment-id="${assignmentId}"]`);
                const phoneCell = row.querySelector('.phone-number');
                phoneCell.textContent = phone;
                
                // Call backend to save assignment
                if (value) {
                    assignLanyard(assignmentId, value);
                } else {
                    // Clear assignment
                    assignLanyard(assignmentId, '');
                }
                
                // Refresh all dropdowns to update availability
                refreshAllDropdowns();
            }
        });
    });
    
    // Add event listeners for checkboxes
    document.querySelectorAll('.checkout-checkbox, .return-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const assignmentId = this.getAttribute('data-assignment-id');
            const action = this.getAttribute('data-action');
            toggleStatus(assignmentId, action, this.checked);
        });
    });
});

function getAssignedAttendantIds() {
    const assignedIds = new Set();
    document.querySelectorAll('.attendant-search').forEach(input => {
        const container = input.closest('.attendant-search-container');
        const assignmentId = container.getAttribute('data-assignment-id');
        const selectedItem = container.querySelector('.dropdown-item[data-selected="true"]');
        
        if (input.value.trim() && selectedItem) {
            const attendantId = selectedItem.getAttribute('data-value');
            if (attendantId) {
                assignedIds.add(attendantId);
            }
        }
    });
    return assignedIds;
}

function filterDropdown(input, dropdown) {
    const filter = input.value.toLowerCase();
    const items = dropdown.querySelectorAll('.dropdown-item');
    const assignedIds = getAssignedAttendantIds();
    const currentContainer = input.closest('.attendant-search-container');
    const currentAssignmentId = currentContainer.getAttribute('data-assignment-id');
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        const attendantId = item.getAttribute('data-value');
        const isEmptyOption = attendantId === '';
        
        // Check if this attendant is already assigned to another badge
        const isAlreadyAssigned = attendantId && assignedIds.has(attendantId);
        
        // Check if this is the currently selected attendant for this badge
        const isCurrentSelection = item.getAttribute('data-selected') === 'true' && 
                                 item.closest('.attendant-search-container').getAttribute('data-assignment-id') === currentAssignmentId;
        
        // Show item if: it matches filter AND (it's empty option OR not already assigned OR it's current selection)
        const matchesFilter = text.includes(filter) || isEmptyOption;
        const shouldShow = matchesFilter && (isEmptyOption || !isAlreadyAssigned || isCurrentSelection);
        
        if (shouldShow) {
            item.style.display = 'block';
            // Add visual indicator for already assigned attendants
            if (isAlreadyAssigned && !isCurrentSelection) {
                item.style.opacity = '0.5';
                item.style.pointerEvents = 'none';
                item.title = 'Already assigned to another badge';
            } else {
                item.style.opacity = '1';
                item.style.pointerEvents = 'auto';
                item.title = '';
            }
        } else {
            item.style.display = 'none';
        }
    });
}

function refreshAllDropdowns() {
    document.querySelectorAll('.attendant-search').forEach(input => {
        const dropdown = input.closest('.attendant-search-container').querySelector('.attendant-dropdown');
        if (dropdown.style.display === 'block') {
            filterDropdown(input, dropdown);
        }
    });
}

function assignLanyard(assignmentId, attendantId) {
    fetch('{% url "scheduler:assign_lanyard" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value
        },
        body: `assignment_id=${assignmentId}&attendant_id=${attendantId}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const row = document.querySelector(`tr[data-assignment-id="${assignmentId}"]`);
            const attendantInput = row.querySelector('.attendant-search');
            const phoneCell = row.querySelector('.phone-number');
            const checkoutCheckbox = row.querySelector('.checkout-checkbox');
            const returnCheckbox = row.querySelector('.return-checkbox');
            
            // Update attendant name and ensure it stays centered
            attendantInput.value = data.attendant_name;
            attendantInput.style.textAlign = 'center';
            
            // Update phone number
            phoneCell.textContent = data.attendant_phone;
            
            // Update selection markers for this dropdown
            const dropdown = row.querySelector('.attendant-dropdown');
            dropdown.querySelectorAll('.dropdown-item').forEach(item => {
                item.removeAttribute('data-selected');
                if (item.getAttribute('data-value') === attendantId) {
                    item.setAttribute('data-selected', 'true');
                }
            });
            
            // Reset checkboxes
            checkoutCheckbox.checked = false;
            returnCheckbox.checked = false;
            
            // Update row status
            row.className = row.className.replace(/status-\w+/g, '');
            
            updateStats();
            
            // Refresh all dropdowns to update availability
            refreshAllDropdowns();
        } else {
            alert('Error assigning lanyard: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while assigning the lanyard.');
    });
}

function toggleStatus(assignmentId, action, checked) {
    const actionType = checked ? action : `undo_${action}`;
    
    fetch('{% url "scheduler:toggle_lanyard_status" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': document.querySelector('input[name="csrfmiddlewaretoken"]').value
        },
        body: `assignment_id=${assignmentId}&action=${actionType}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const row = document.querySelector(`tr[data-assignment-id="${assignmentId}"]`);
            updateRowStatus(row, data.checked_out, data.returned);
            updateStats();
        } else {
            alert('Error updating status: ' + data.error);
            // Revert checkbox state
            const checkbox = document.querySelector(`input[data-assignment-id="${assignmentId}"][data-action="${action}"]`);
            if (checkbox) {
                checkbox.checked = !checked;
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while updating the status.');
        // Revert checkbox state
        const checkbox = document.querySelector(`input[data-assignment-id="${assignmentId}"][data-action="${action}"]`);
        if (checkbox) {
            checkbox.checked = !checked;
        }
    });
}

function updateRowStatus(row, checkedOut, returned) {
    row.classList.remove('status-checked-out', 'status-returned');
    if (returned) {
        row.classList.add('status-returned');
    } else if (checkedOut) {
        row.classList.add('status-checked-out');
    }
}

function updateStats() {
    const rows = document.querySelectorAll('tbody tr[data-assignment-id]');
    let assigned = 0;
    let checkedOut = 0;
    let returned = 0;
    
    rows.forEach(row => {
        const attendantInput = row.querySelector('.attendant-search');
        const checkoutCheckbox = row.querySelector('.checkout-checkbox');
        const returnCheckbox = row.querySelector('.return-checkbox');
        
        if (attendantInput && attendantInput.value.trim()) {
            assigned++;
            if (returnCheckbox && returnCheckbox.checked) {
                returned++;
            } else if (checkoutCheckbox && checkoutCheckbox.checked) {
                checkedOut++;
            }
        }
    });
    
    document.getElementById('total-assigned').textContent = assigned;
    document.getElementById('total-checked-out').textContent = checkedOut;
    document.getElementById('total-returned').textContent = returned;
}

// Export to PDF functionality
function exportToPDF() {
    const eventName = '{{ current_event.name|escapejs }}';
    const eventDate = '{{ current_event.start_date|date:"F j, Y"|escapejs }}';
    
    // Create a new window for printing
    const printWindow = window.open('', '_blank');
    const printContent = generatePrintableReport();
    
    printWindow.document.write('<!DOCTYPE html>' +
        '<html>' +
        '<head>' +
        '<title>Lanyard Tracking Report - ' + eventName + '</title>' +
        '<style>' +
        'body { font-family: Arial, sans-serif; margin: 20px; }' +
        '.header { text-align: center; margin-bottom: 30px; }' +
        '.info-section { margin-bottom: 20px; }' +
        '.info-row { display: flex; margin-bottom: 10px; }' +
        '.info-label { font-weight: bold; width: 200px; }' +
        '.info-value { border-bottom: 1px solid #000; flex: 1; }' +
        'table { width: 100%; border-collapse: collapse; margin: 20px 0; }' +
        'th, td { border: 1px solid #000; padding: 8px; text-align: left; }' +
        'th { background-color: #f0f0f0; }' +
        '.summary { margin-top: 30px; }' +
        '@media print { body { margin: 0; } .no-print { display: none; } }' +
        '</style>' +
        '</head>' +
        '<body>' +
        printContent +
        '<script>' +
        'window.onload = function() { window.print(); window.close(); };' +
        '<\/script>' +
        '</body>' +
        '</html>');
    printWindow.document.close();
}

// Email report functionality
function emailReport() {
    const eventName = '{{ current_event.name|escapejs }}';
    const eventDate = '{{ current_event.start_date|date:"F j, Y"|escapejs }}';
    
    // Get assignment data
    const assignments = [];
    document.querySelectorAll('tbody tr[data-assignment-id]').forEach(row => {
        const badgeNumber = row.querySelector('.badge-number').textContent;
        const attendantName = row.querySelector('.attendant-search').value || 'Unassigned';
        const phoneNumber = row.querySelector('.phone-number').textContent || '';
        const checkedOut = row.querySelector('.checkout-checkbox').checked;
        const returned = row.querySelector('.return-checkbox').checked;
        
        if (attendantName !== 'Unassigned') {
            assignments.push({
                badge: badgeNumber,
                name: attendantName,
                phone: phoneNumber,
                status: returned ? 'Returned' : (checkedOut ? 'Checked Out' : 'Assigned')
            });
        }
    });
    
    // Create email body
    let emailBody = 'Lanyard Tracking Report\\n\\n';
    emailBody += 'Event: ' + eventName + '\\n';
    emailBody += 'Date: ' + eventDate + '\\n\\n';
    emailBody += 'ASSIGNMENTS:\\n';
    emailBody += 'Badge# | Attendant Name | Phone | Status\\n';
    emailBody += '------|----------------|-------|-------\\n';
    
    assignments.forEach(assignment => {
        emailBody += assignment.badge + ' | ' + assignment.name + ' | ' + assignment.phone + ' | ' + assignment.status + '\\n';
    });
    
    emailBody += '\\n\\nTotal Assigned: ' + assignments.length + '\\n';
    emailBody += 'Total Checked Out: ' + assignments.filter(a => a.status === 'Checked Out').length + '\\n';
    emailBody += 'Total Returned: ' + assignments.filter(a => a.status === 'Returned').length + '\\n';
    
    // Create mailto link
    const subject = encodeURIComponent('Lanyard Tracking Report - ' + eventName);
    const body = encodeURIComponent(emailBody);
    const mailtoLink = 'mailto:?subject=' + subject + '&body=' + body;
    
    window.location.href = mailtoLink;
}

// Generate printable report content
function generatePrintableReport() {
    const eventName = '{{ current_event.name|escapejs }}';
    const eventDate = '{{ current_event.start_date|date:"F j, Y"|escapejs }}';
    const eventLocation = '{{ current_event.location|default:"TBD"|escapejs }}';
    
    let content = '<div class="header">' +
        '<h1>Attendant Lanyard Tracking</h1>' +
        '</div>' +
        '<div class="info-section">' +
        '<div class="info-row">' +
        '<div class="info-label">Date:</div>' +
        '<div class="info-value">' + eventDate + '</div>' +
        '</div>' +
        '<div class="info-row">' +
        '<div class="info-label">Circuit/Convention:</div>' +
        '<div class="info-value">' + eventName + '</div>' +
        '</div>' +
        '<div class="info-row">' +
        '<div class="info-label">Assembly Overseer/ CCt Name:</div>' +
        '<div class="info-value"></div>' +
        '</div>' +
        '<div class="info-row">' +
        '<div class="info-label">Attendant Overseer Name:</div>' +
        '<div class="info-value"></div>' +
        '</div>' +
        '<div class="info-row">' +
        '<div class="info-label">Phone:</div>' +
        '<div class="info-value"></div>' +
        '</div>' +
        '</div>' +
        '<table>' +
        '<thead>' +
        '<tr>' +
        '<th>Badge #</th>' +
        '<th>Attendant Name</th>' +
        '<th>Phone Number</th>' +
        '<th>Checked-out</th>' +
        '<th>Returned</th>' +
        '</tr>' +
        '</thead>' +
        '<tbody>';
    
    // Add assignment rows
    document.querySelectorAll('tbody tr[data-assignment-id]').forEach(row => {
        const badgeNumber = row.querySelector('.badge-number').textContent;
        const attendantName = row.querySelector('.attendant-search').value || '';
        const phoneNumber = row.querySelector('.phone-number').textContent || '';
        const checkedOut = row.querySelector('.checkout-checkbox').checked ? '✓' : '';
        const returned = row.querySelector('.return-checkbox').checked ? '✓' : '';
        
        content += '<tr>' +
            '<td>' + badgeNumber + '</td>' +
            '<td>' + attendantName + '</td>' +
            '<td>' + phoneNumber + '</td>' +
            '<td style="text-align: center;">' + checkedOut + '</td>' +
            '<td style="text-align: center;">' + returned + '</td>' +
            '</tr>';
    });
    
    content += '</tbody>' +
        '</table>' +
        '<div class="summary">' +
        '<div class="info-row">' +
        '<div class="info-label">Number of Lanyards received by AH:</div>' +
        '<div class="info-value"></div>' +
        '</div>' +
        '<div class="info-row">' +
        '<div class="info-label">Lanyards returned to AH:</div>' +
        '<div class="info-value"></div>' +
        '</div>' +
        '<div class="info-row">' +
        '<div class="info-label">Lanyards to recover and return:</div>' +
        '<div class="info-value"></div>' +
        '</div>' +
        '</div>' +
        '<div style="margin-top: 30px; padding: 15px; border: 1px solid #ccc; background-color: #f9f9f9;">' +
        '<strong>Note:</strong> If a lanyard is missing please follow through with the attendant and arrange for the missing lanyard to be returned to the Assembly Hall. Please provide a copy of this tracking form to the AH when you return the lanyards.' +
        '</div>';
    
    return content;
}
</script>
{% endblock %}
