{% extends "admin/change_form.html" %}
{% load i18n admin_urls static %}

{% block submit_buttons_bottom %}
    {{ block.super }}
    
    <div class="submit-row" style="margin-top: 20px; padding: 10px; background: #f8f9fa; border-radius: 4px;">
        <h3 style="margin-top: 0;">Gmail Setup</h3>
        
        {% if has_app_password %}
            <div style="margin-bottom: 10px;">
                <span class="badge" style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px;">
                    ‚úì Gmail Connected via App Password: {{ original.gmail_email }}
                </span>
            </div>
        {% elif has_oauth_token %}
            <div style="margin-bottom: 10px;">
                <span class="badge" style="background: #28a745; color: white; padding: 4px 8px; border-radius: 4px;">
                    ‚úì Gmail Connected via OAuth2: {{ original.gmail_email }}
                </span>
            </div>
        {% else %}
            <div style="margin-bottom: 10px;">
                <span class="badge" style="background: #dc3545; color: white; padding: 4px 8px; border-radius: 4px;">
                    ‚úó Gmail Not Connected
                </span>
            </div>
        {% endif %}
        
        <!-- App Password Method (Recommended) -->
        <div style="margin-bottom: 20px; padding: 15px; border: 2px solid #28a745; border-radius: 8px; background: #f8fff9;">
            <h4 style="color: #28a745; margin-top: 0;">‚úÖ Recommended: App Password Method</h4>
            <p><strong>Simple 2-step setup:</strong></p>
            <ol>
                <li>Go to <a href="https://myaccount.google.com/security" target="_blank">Google Account Security</a></li>
                <li>Enable 2-Step Verification ‚Üí App Passwords ‚Üí Generate password for "Mail"</li>
            </ol>
            
            <div style="margin-top: 10px;">
                <div style="margin-bottom: 10px;">
                    <label>Gmail Address:</label><br>
                    <input type="email" id="gmail_email" placeholder="your-email@gmail.com" 
                           value="{{ original.gmail_email }}" style="width: 300px; padding: 5px;">
                </div>
                <div style="margin-bottom: 10px;">
                    <label>App Password (16 characters):</label><br>
                    <input type="password" id="app_password" placeholder="abcd efgh ijkl mnop" 
                           style="width: 300px; padding: 5px;">
                </div>
                <button type="button" onclick="configureAppPassword()" class="button" style="background: #28a745; color: white;">
                    üîê Configure App Password
                </button>
                <div id="config-result" style="margin-top: 10px; padding: 10px; border-radius: 4px; display: none;"></div>
            </div>
        </div>
        
        <!-- OAuth2 Method (Advanced) -->
        <div style="margin-bottom: 15px; padding: 15px; border: 1px solid #ffc107; border-radius: 8px; background: #fffbf0;">
            <h4 style="color: #856404; margin-top: 0;">‚öôÔ∏è Advanced: OAuth2 Method</h4>
            <p>Requires Google Cloud Console setup</p>
            <div class="gmail-auth-buttons">
                <a href="{{ gmail_auth_start_url }}" 
                   class="button" 
                   style="background: #4285f4; color: white; margin-right: 10px;">
                    üîê OAuth2 Setup
                </a>
            </div>
        </div>
        
        <!-- Test & Management -->
        <div class="gmail-management" style="margin-top: 15px;">
            <div class="gmail-status">
                <h3>Gmail Setup Status</h3>
                {% if has_app_password %}
                    <div class="status-indicator connected">
                        <span class="status-dot"></span>
                        <strong>App Password Configured</strong> - Gmail ready via SMTP ({{ original.gmail_email }})
                    </div>
                {% elif has_oauth_token %}
                    <div class="status-indicator connected">
                        <span class="status-dot"></span>
                        <strong>OAuth2 Connected</strong> - Gmail API is authenticated and ready
                    </div>
                {% else %}
                    <div class="status-indicator not-connected">
                        <span class="status-dot"></span>
                        <strong>Not Connected</strong> - Choose App Password (recommended) or OAuth2 method below
                    </div>
                {% endif %}
            </div>
            
            <button type="button" 
                    onclick="testGmailConnection()" 
                    class="button" 
                    style="background: #17a2b8; color: white; margin-right: 10px;">
                üß™ Test Email
            </button>
            
            {% if has_app_password or has_oauth_token %}
                <a href="/gmail/app-password/remove/" 
                   class="button" 
                   style="background: #dc3545; color: white;"
                   onclick="return confirm('Remove Gmail configuration?')">
                    üóëÔ∏è Remove Gmail
                </a>
            {% endif %}
            
            <div id="test-result" style="margin-top: 15px; padding: 10px; border-radius: 4px; display: none;"></div>
        </div>
    </div>

    <script>
    function configureAppPassword() {
        const gmail = document.getElementById('gmail_email').value;
        const password = document.getElementById('app_password').value;
        const resultDiv = document.getElementById('config-result');
        
        if (!gmail || !password) {
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px;">‚ùå Please enter both Gmail address and App Password</div>';
            return;
        }
        
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div style="color: #666;">Configuring Gmail App Password...</div>';
        
        fetch('/gmail/app-password/configure/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: `gmail_email=${encodeURIComponent(gmail)}&app_password=${encodeURIComponent(password)}`
        })
        .then(response => {
            if (response.redirected) {
                // Configuration successful, reload page to show updated status
                window.location.reload();
            } else {
                return response.json();
            }
        })
        .then(data => {
            if (data && data.success) {
                resultDiv.innerHTML = '<div style="color: #28a745; background: #d4edda; padding: 10px; border-radius: 4px;">‚úÖ ' + data.message + '</div>';
                setTimeout(() => window.location.reload(), 2000);
            } else if (data) {
                resultDiv.innerHTML = '<div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px;">‚ùå ' + (data.message || 'Configuration failed') + '</div>';
            }
        })
        .catch(error => {
            resultDiv.innerHTML = '<div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px;">‚ùå Error: ' + error.message + '</div>';
        });
    }
    
    function testGmailConnection() {
        const resultDiv = document.getElementById('test-result');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = '<div style="color: #666;">Testing Gmail connection...</div>';
        
        fetch('/gmail/app-password/test/', {
            method: 'GET',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultDiv.innerHTML = '<div style="color: #28a745; background: #d4edda; padding: 10px; border-radius: 4px;">‚úÖ ' + data.message + '</div>';
            } else {
                resultDiv.innerHTML = '<div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px;">‚ùå ' + data.message + '</div>';
            }
        })
        .catch(error => {
            resultDiv.innerHTML = '<div style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 4px;">‚ùå Error: ' + error.message + '</div>';
        });
    }
    </script>
{% endblock %}
