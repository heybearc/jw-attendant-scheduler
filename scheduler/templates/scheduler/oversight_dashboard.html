{% extends 'scheduler/base.html' %}

{% block title %}Oversight Dashboard - JW Attendant Scheduler{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-chart-line"></i> Oversight Dashboard</h1>
    <div class="btn-group" role="group">
        <a href="?period=7" class="btn btn-outline-primary {% if period == '7' %}active{% endif %}">7 Days</a>
        <a href="?period=30" class="btn btn-outline-primary {% if period == '30' %}active{% endif %}">30 Days</a>
        <a href="?period=90" class="btn btn-outline-primary {% if period == '90' %}active{% endif %}">90 Days</a>
        <a href="?period=365" class="btn btn-outline-primary {% if period == '365' %}active{% endif %}">1 Year</a>
    </div>
</div>

<div class="alert alert-info mb-4">
    <i class="fas fa-info-circle"></i> Showing data for <strong>{{ period_name }}</strong> 
    ({{ start_date|date:"M d, Y" }} - {{ end_date|date:"M d, Y" }})
</div>

<!-- Key Metrics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ total_attendants }}</h4>
                        <p class="mb-0">Total Attendants</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
                <small>{{ active_attendants }} active ({{ attendant_utilization }}%)</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ total_assignments }}</h4>
                        <p class="mb-0">Total Assignments</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-calendar-check fa-2x"></i>
                    </div>
                </div>
                <small>{{ avg_assignments_per_event }} avg per event</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ total_hours }}</h4>
                        <p class="mb-0">Total Hours</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                </div>
                <small>{{ avg_hours_per_attendant }} avg per attendant</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ upcoming_events }}</h4>
                        <p class="mb-0">Upcoming Events</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-calendar-alt fa-2x"></i>
                    </div>
                </div>
                <small>{{ total_events }} total in period</small>
            </div>
        </div>
    </div>
</div>

<!-- Alerts and Attention Items -->
{% if conflicts or upcoming_events_detail %}
<div class="row mb-4">
    {% if conflicts %}
    <div class="col-md-6">
        <div class="card border-danger">
            <div class="card-header bg-danger text-white">
                <h5><i class="fas fa-exclamation-triangle"></i> Assignment Conflicts</h5>
            </div>
            <div class="card-body">
                {% for conflict in conflicts %}
                <div class="alert alert-warning mb-2">
                    <strong>{{ conflict.assignment.attendant.get_full_name }}</strong><br>
                    <small>{{ conflict.assignment.event.name }} conflicts with:</small>
                    <ul class="mb-0 mt-1">
                        {% for conf in conflict.conflicts %}
                        <li>{{ conf.event.name }} ({{ conf.shift_start|date:"M d H:i" }} - {{ conf.shift_end|date:"H:i" }})</li>
                        {% endfor %}
                    </ul>
                </div>
                {% endfor %}
                {% if conflicts|length > 5 %}
                <p class="text-muted">Showing first 5 conflicts...</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if upcoming_events_detail %}
    <div class="col-md-6">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5><i class="fas fa-exclamation-circle"></i> Events Needing Attention</h5>
            </div>
            <div class="card-body">
                {% for item in upcoming_events_detail %}
                <div class="alert alert-info mb-2">
                    <strong>{{ item.event.name }}</strong><br>
                    <small>{{ item.event.start_date|date:"M d, Y H:i" }}</small><br>
                    <span class="badge bg-warning">{{ item.shortage }} more attendant{{ item.shortage|pluralize }} needed</span>
                    <span class="badge bg-info">{{ item.assigned_count }}/{{ item.event.min_attendants }} assigned</span>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Analytics Row -->
<div class="row mb-4">
    <!-- Serving Positions Chart -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie"></i> Serving Positions Distribution</h5>
            </div>
            <div class="card-body">
                {% if serving_positions %}
                <canvas id="servingPositionsChart" width="400" height="200"></canvas>
                {% else %}
                <p class="text-muted">No serving position data available.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Assignment Trends Chart -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> Assignment Trends</h5>
            </div>
            <div class="card-body">
                {% if assignment_trends %}
                <canvas id="assignmentTrendsChart" width="400" height="200"></canvas>
                {% else %}
                <p class="text-muted">No assignment trend data available.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Data Tables Row -->
<div class="row mb-4">
    <!-- Top Performers -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-trophy"></i> Top Performers</h5>
            </div>
            <div class="card-body">
                {% if top_performers %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Attendant</th>
                                <th>Hours</th>
                                <th>Assignments</th>
                                <th>Events</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for performer in top_performers %}
                            <tr>
                                <td>{{ performer.attendant__first_name }} {{ performer.attendant__last_name }}</td>
                                <td>{{ performer.total_hours|floatformat:1 }}</td>
                                <td>{{ performer.assignment_count }}</td>
                                <td>{{ performer.event_count }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No performance data available for this period.</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Event Capacity -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Event Capacity Status</h5>
            </div>
            <div class="card-body">
                {% if event_capacity %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Event</th>
                                <th>Date</th>
                                <th>Capacity</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for event in event_capacity|slice:":10" %}
                            <tr>
                                <td>{{ event.name|truncatechars:30 }}</td>
                                <td>{{ event.start_date|date:"M d" }}</td>
                                <td>{{ event.assigned_count }}/{{ event.min_attendants }}</td>
                                <td>
                                    {% if event.capacity_percentage >= 100 %}
                                    <span class="badge bg-success">{{ event.capacity_percentage|floatformat:0 }}%</span>
                                    {% elif event.capacity_percentage >= 80 %}
                                    <span class="badge bg-warning">{{ event.capacity_percentage|floatformat:0 }}%</span>
                                    {% else %}
                                    <span class="badge bg-danger">{{ event.capacity_percentage|floatformat:0 }}%</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">No event capacity data available for this period.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Inactive Attendants -->
{% if inactive_attendants %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-user-clock"></i> Inactive Attendants (No Recent Assignments)</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for attendant in inactive_attendants %}
                    <div class="col-md-3 mb-2">
                        <span class="badge bg-secondary">{{ attendant.get_full_name }}</span>
                    </div>
                    {% endfor %}
                </div>
                {% if inactive_attendants|length >= 20 %}
                <p class="text-muted mt-2">Showing first 20 inactive attendants...</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Quick Actions -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-tools"></i> Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="btn-group me-2" role="group">
                    <a href="{% url 'scheduler:attendant_create' %}" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> Add Attendant
                    </a>
                    <a href="{% url 'scheduler:event_create' %}" class="btn btn-success">
                        <i class="fas fa-calendar-plus"></i> Create Event
                    </a>
                    <a href="{% url 'scheduler:assignment_create' %}" class="btn btn-info">
                        <i class="fas fa-plus"></i> New Assignment
                    </a>
                </div>
                <div class="btn-group me-2" role="group">
                    <a href="{% url 'scheduler:reports' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-chart-bar"></i> Detailed Reports
                    </a>
                    <a href="{% url 'scheduler:user_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-users-cog"></i> Manage Users
                    </a>
                </div>
                <div class="btn-group" role="group">
                    <a href="{% url 'scheduler:export_attendants' %}?format=csv" class="btn btn-outline-primary">
                        <i class="fas fa-download"></i> Export Data
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Serving Positions Pie Chart
{% if serving_positions %}
const servingCtx = document.getElementById('servingPositionsChart').getContext('2d');
new Chart(servingCtx, {
    type: 'pie',
    data: {
        labels: [{% for position, count in serving_positions.items %}'{{ position }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            data: [{% for position, count in serving_positions.items %}{{ count }}{% if not forloop.last %},{% endif %}{% endfor %}],
            backgroundColor: [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
            ]
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
{% endif %}

// Assignment Trends Line Chart
{% if assignment_trends %}
const trendsCtx = document.getElementById('assignmentTrendsChart').getContext('2d');
new Chart(trendsCtx, {
    type: 'line',
    data: {
        labels: [{% for trend in assignment_trends %}'{{ trend.day|date:"M d" }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: 'Assignments',
            data: [{% for trend in assignment_trends %}{{ trend.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#36A2EB',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            tension: 0.4
        }, {
            label: 'Hours',
            data: [{% for trend in assignment_trends %}{{ trend.hours|floatformat:1 }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#FF6384',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            tension: 0.4,
            yAxisID: 'y1'
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                    display: true,
                    text: 'Assignments'
                }
            },
            y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                    display: true,
                    text: 'Hours'
                },
                grid: {
                    drawOnChartArea: false,
                }
            }
        },
        plugins: {
            legend: {
                position: 'top'
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}
