"use strict";(()=>{var e={};e.id=2569,e.ids=[2569],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},9868:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>N,patchFetch:()=>E,requestAsyncStorage:()=>w,routeModule:()=>f,serverHooks:()=>v,staticGenerationAsyncStorage:()=>g});var a={};s.r(a),s.d(a,{GET:()=>d,POST:()=>c});var r=s(9303),i=s(8716),o=s(670),n=s(7070),l=s(3524),m=s(4770),u=s.n(m);let p=new l.PrismaClient;async function d(e){let t=`firstName,lastName,email,phone,role,department,notes
John,Smith,john.smith@email.com,(555) 123-4567,ATTENDANT,Sound,Has experience with sound equipment
Mary,Johnson,mary.j@email.com,(555) 987-6543,KEYMAN,Platform,Platform coordinator for 5+ years
David,Brown,d.brown@email.com,,OVERSEER,Overall,Circuit overseer visit coordinator
Sarah,Wilson,sarah.w@email.com,(555) 456-7890,ASSISTANT_OVERSEER,Attendants,Assists with attendant scheduling`;return new n.NextResponse(t,{status:200,headers:{"Content-Type":"text/csv","Content-Disposition":'attachment; filename="user_import_template.csv"'}})}async function c(e){try{let t=(await e.formData()).get("file");if(!t)return n.NextResponse.json({error:"No file provided"},{status:400});if(!t.name.endsWith(".csv"))return n.NextResponse.json({error:"File must be a CSV"},{status:400});let s=await t.text(),a=await h(s);return n.NextResponse.json(a)}catch(e){return console.error("Failed to import users:",e),n.NextResponse.json({error:"Failed to import users"},{status:500})}}async function h(e){let t=e.trim().split("\n"),a=t[0].split(",").map(e=>e.trim()),r=["firstName","lastName","email","role"].filter(e=>!a.includes(e));if(r.length>0)return{success:!1,totalRows:0,successCount:0,errorCount:1,errors:[{row:0,field:"headers",message:`Missing required headers: ${r.join(", ")}`,value:a.join(", ")}],createdUsers:[]};let i=t.slice(1),o=[],n=[];for(let e=0;e<i.length;e++){let t=e+2,s=i[e].split(",").map(e=>e.trim().replace(/^"|"$/g,""));if(s.length!==a.length){o.push({row:t,field:"structure",message:`Row has ${s.length} columns, expected ${a.length}`,value:i[e]});continue}let r={};a.forEach((e,t)=>{r[e]=s[t]||null});let l=function(e,t){let s=[];if(e.firstName&&""!==e.firstName.trim()||s.push({row:t,field:"firstName",message:"First name is required",value:e.firstName||""}),e.lastName&&""!==e.lastName.trim()||s.push({row:t,field:"lastName",message:"Last name is required",value:e.lastName||""}),e.email&&""!==e.email.trim()?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e.email)||s.push({row:t,field:"email",message:"Invalid email format",value:e.email}):s.push({row:t,field:"email",message:"Email is required",value:e.email||""}),e.role&&""!==e.role.trim()){let a=["ADMIN","OVERSEER","ASSISTANT_OVERSEER","KEYMAN","ATTENDANT"];a.includes(e.role.toUpperCase())||s.push({row:t,field:"role",message:`Invalid role. Must be one of: ${a.join(", ")}`,value:e.role})}else s.push({row:t,field:"role",message:"Role is required",value:e.role||""});return e.phone&&""!==e.phone.trim()&&!/^[\+]?[1-9][\d]{0,15}$|^\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}$/.test(e.phone.replace(/\s+/g,""))&&s.push({row:t,field:"phone",message:"Invalid phone format",value:e.phone}),s}(r,t);if(l.length>0){o.push(...l);continue}n.push(r)}let l=new Map;n.forEach((e,t)=>{let s=e.email.toLowerCase();l.has(s)||l.set(s,[]),l.get(s).push(t+2)}),l.forEach((e,t)=>{e.length>1&&e.forEach(e=>{o.push({row:e,field:"email",message:"Duplicate email in import file",value:t})})});let m=new Set((await p.users.findMany({where:{email:{in:n.map(e=>e.email.toLowerCase())}},select:{email:!0}})).map(e=>e.email.toLowerCase()));if(n.forEach((e,t)=>{m.has(e.email.toLowerCase())&&o.push({row:t+2,field:"email",message:"Email already exists in system",value:e.email})}),o.length>0)return{success:!1,totalRows:i.length,successCount:0,errorCount:o.length,errors:o,createdUsers:[]};let d=[],{EmailService:c}=await s.e(2323).then(s.bind(s,2323));try{return await p.$transaction(async e=>{for(let t of n){let s=u().randomBytes(32).toString("hex"),a=new Date(Date.now()+6048e5),r=await e.users.create({data:{id:u().randomUUID(),email:t.email.toLowerCase(),firstName:t.firstName,lastName:t.lastName,phone:t.phone||null,role:t.role,passwordHash:null,isActive:!0,inviteToken:s,inviteExpiry:a,updatedAt:new Date},select:{id:!0,email:!0,firstName:!0,lastName:!0,phone:!0,role:!0,isActive:!0,inviteToken:!0,inviteExpiry:!0,createdAt:!0}}),i=await c.sendInvitationEmail(r.email,`${r.firstName} ${r.lastName}`,s);i||console.warn(`[USER_IMPORT] Failed to send invitation email to ${r.email}`),d.push({...r,department:t.department,notes:t.notes,emailSent:i})}}),console.log(`[USER_IMPORT] Successfully imported ${d.length} users`),{success:!0,totalRows:i.length,successCount:d.length,errorCount:0,errors:[],createdUsers:d}}catch(e){throw console.error("[USER_IMPORT] Transaction failed:",e),e}}let f=new r.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/admin/users/import/route",pathname:"/api/admin/users/import",filename:"route",bundlePath:"app/api/admin/users/import/route"},resolvedPagePath:"/Users/cory/Documents/Cloudy-Work/applications/jw-attendant-scheduler/app/api/admin/users/import/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:w,staticGenerationAsyncStorage:g,serverHooks:v}=f,N="/api/admin/users/import/route";function E(){return(0,o.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:g})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),a=t.X(0,[9276,5972],()=>s(9868));module.exports=a})();