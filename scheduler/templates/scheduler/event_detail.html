{% extends 'scheduler/base.html' %}
{% load static %}

{% block title %}{{ event.name }} - Event Management{% endblock %}

{% block extra_css %}
<style>
    .nav-tabs .nav-link {
        color: #495057;
        border: 1px solid transparent;
        border-top-left-radius: 0.375rem;
        border-top-right-radius: 0.375rem;
    }
    .nav-tabs .nav-link:hover {
        border-color: #e9ecef #e9ecef #dee2e6;
        isolation: isolate;
    }
    .nav-tabs .nav-link.active {
        color: #495057;
        background-color: #fff;
        border-color: #dee2e6 #dee2e6 #fff;
    }
    .tab-content {
        border: 1px solid #dee2e6;
        border-top: none;
        padding: 1.5rem;
        background-color: #fff;
    }
    .quick-stats {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    .stat-card {
        text-align: center;
        padding: 1rem;
    }
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        display: block;
    }
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Event Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="bi bi-calendar-event"></i> {{ event.name }}</h1>
                    <p class="text-muted mb-0">
                        <i class="bi bi-calendar"></i> {{ event.start_date|date:"M d, Y" }}
                        {% if event.end_date %} - {{ event.end_date|date:"M d, Y" }}{% endif %}
                    </p>
                </div>
                <div>
                    <a href="{% url 'scheduler:event_selection' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Change Event
                    </a>
                    {% if user.role == 'admin' or user.role == 'overseer' or user.is_staff %}
                    <a href="{% url 'scheduler:event_edit' event.id %}" class="btn btn-primary ms-2">
                        <i class="bi bi-pencil"></i> Edit Event
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row">
        <div class="col-12">
            <div class="quick-stats">
                <div class="row">
                    <div class="col-md-3 stat-card">
                        <span class="stat-number">{{ attendants_count }}</span>
                        <span class="stat-label">Attendants</span>
                    </div>
                    <div class="col-md-3 stat-card">
                        <span class="stat-number">{{ assignments_count }}</span>
                        <span class="stat-label">Assignments</span>
                    </div>
                    <div class="col-md-3 stat-card">
                        <span class="stat-number">{{ positions_count }}</span>
                        <span class="stat-label">Positions</span>
                    </div>
                    <div class="col-md-3 stat-card">
                        <span class="stat-number">{{ days_until_event }}</span>
                        <span class="stat-label">Days Until Event</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Management Tabs -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs" id="eventTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="attendants-tab" data-bs-toggle="tab" data-bs-target="#attendants" type="button" role="tab">
                        <i class="bi bi-people"></i> Attendants
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="assignments-tab" data-bs-toggle="tab" data-bs-target="#assignments" type="button" role="tab">
                        <i class="bi bi-calendar-check"></i> Assignments
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab">
                        <i class="bi bi-graph-up"></i> Reports
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="eventTabContent">
                <!-- Attendants Tab -->
                <div class="tab-pane fade show active" id="attendants" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="bi bi-people"></i> Event Attendants</h4>
                        <div>
                            <a href="{% url 'scheduler:attendant_create' %}" class="btn btn-success">
                                <i class="bi bi-person-plus"></i> Add Attendant
                            </a>
                            <a href="{% url 'scheduler:import_attendants' %}" class="btn btn-outline-primary ms-2">
                                <i class="bi bi-upload"></i> Import CSV
                            </a>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            {% if event_attendants %}
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Phone</th>
                                            <th>Congregation</th>
                                            <th>Serving As</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for attendant in event_attendants %}
                                        <tr>
                                            <td>
                                                <strong>{{ attendant.get_full_name }}</strong>
                                            </td>
                                            <td>{{ attendant.email|default:"-" }}</td>
                                            <td>{{ attendant.phone|default:"-" }}</td>
                                            <td>{{ attendant.congregation|default:"-" }}</td>
                                            <td>
                                                {% if attendant.serving_as %}
                                                    {% for role in attendant.serving_as %}
                                                        <span class="badge bg-secondary me-1">{{ role|title }}</span>
                                                    {% endfor %}
                                                {% else %}
                                                    <span class="badge bg-light text-dark">Publisher</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <a href="{% url 'scheduler:attendant_detail' attendant.id %}" class="btn btn-outline-primary" title="View Details">
                                                        <i class="bi bi-eye"></i>
                                                    </a>
                                                    <a href="{% url 'scheduler:attendant_edit' attendant.id %}" class="btn btn-outline-secondary" title="Edit">
                                                        <i class="bi bi-pencil"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="bi bi-people" style="font-size: 3rem; color: #ccc;"></i>
                                <h5 class="mt-3 text-muted">No attendants for this event yet</h5>
                                <p class="text-muted">Add attendants individually or import from a CSV file.</p>
                                <div class="mt-3">
                                    <a href="{% url 'scheduler:attendant_create' %}" class="btn btn-primary me-2">
                                        <i class="bi bi-person-plus"></i> Add First Attendant
                                    </a>
                                    <a href="{% url 'scheduler:import_attendants' %}" class="btn btn-outline-primary">
                                        <i class="bi bi-upload"></i> Import CSV
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Assignments Tab -->
                <div class="tab-pane fade" id="assignments" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="bi bi-calendar-check"></i> Event Assignments</h4>
                        <div>
                            <a href="{% url 'scheduler:assignment_create' %}" class="btn btn-success">
                                <i class="bi bi-plus-circle"></i> Create Assignment
                            </a>
                            <a href="{% url 'scheduler:bulk_assignment_create' %}" class="btn btn-outline-primary ms-2">
                                <i class="bi bi-list-check"></i> Bulk Create
                            </a>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            {% if assignments %}
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Attendant</th>
                                            <th>Position</th>
                                            <th>Shift Start</th>
                                            <th>Shift End</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for assignment in assignments %}
                                        <tr>
                                            <td>
                                                <strong>{{ assignment.attendant.get_full_name }}</strong>
                                                <br><small class="text-muted">{{ assignment.attendant.congregation|default:"-" }}</small>
                                            </td>
                                            <td>
                                                <span class="badge bg-primary">{{ assignment.position }}</span>
                                            </td>
                                            <td>{{ assignment.shift_start|date:"M d, Y H:i" }}</td>
                                            <td>{{ assignment.shift_end|date:"M d, Y H:i" }}</td>
                                            <td>
                                                {% if assignment.confirmed %}
                                                    <span class="badge bg-success">Confirmed</span>
                                                {% else %}
                                                    <span class="badge bg-warning">Pending</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <a href="{% url 'scheduler:assignment_edit' assignment.id %}" class="btn btn-outline-secondary" title="Edit">
                                                        <i class="bi bi-pencil"></i>
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% else %}
                            <div class="text-center py-5">
                                <i class="bi bi-calendar-check" style="font-size: 3rem; color: #ccc;"></i>
                                <h5 class="mt-3 text-muted">No assignments for this event yet</h5>
                                <p class="text-muted">Create assignments for attendants to specific positions and shifts.</p>
                                <div class="mt-3">
                                    <a href="{% url 'scheduler:assignment_create' %}" class="btn btn-primary me-2">
                                        <i class="bi bi-plus-circle"></i> Create First Assignment
                                    </a>
                                    <a href="{% url 'scheduler:bulk_assignment_create' %}" class="btn btn-outline-primary">
                                        <i class="bi bi-list-check"></i> Bulk Create
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div class="tab-pane fade" id="reports" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h4><i class="bi bi-graph-up"></i> Event Reports</h4>
                        <div>
                            <a href="{% url 'scheduler:export_event_schedule' event.id %}" class="btn btn-outline-info">
                                <i class="bi bi-file-pdf"></i> Export Schedule
                            </a>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-bar-chart"></i> Assignment Statistics</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <h4 class="text-primary">{{ assignments_count }}</h4>
                                            <small class="text-muted">Total Assignments</small>
                                        </div>
                                        <div class="col-6">
                                            <h4 class="text-success">{{ attendants_count }}</h4>
                                            <small class="text-muted">Attendants</small>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <h4 class="text-info">{{ positions_count }}</h4>
                                            <small class="text-muted">Positions</small>
                                        </div>
                                        <div class="col-6">
                                            <h4 class="text-warning">{{ days_until_event }}</h4>
                                            <small class="text-muted">Days Until Event</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-people"></i> Attendant Breakdown</h6>
                                </div>
                                <div class="card-body">
                                    {% if assignments_by_position %}
                                        {% for position, position_assignments in assignments_by_position.items %}
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="badge bg-primary">{{ position }}</span>
                                            <span class="fw-bold">{{ position_assignments|length }} assigned</span>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <p class="text-muted text-center">No assignments created yet</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="bi bi-download"></i> Export Options</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <div class="d-grid">
                                                <a href="{% url 'scheduler:export_event_schedule' event.id %}" class="btn btn-outline-primary">
                                                    <i class="bi bi-file-pdf"></i> Event Schedule PDF
                                                </a>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="d-grid">
                                                <a href="{% url 'scheduler:export_attendants' %}?event={{ event.id }}" class="btn btn-outline-success">
                                                    <i class="bi bi-file-excel"></i> Attendants CSV
                                                </a>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="d-grid">
                                                <a href="{% url 'scheduler:export_assignments' %}?event={{ event.id }}" class="btn btn-outline-info">
                                                    <i class="bi bi-file-excel"></i> Assignments CSV
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Event Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <th width="40%">Event Type:</th>
                                    <td>
                                        <span class="badge badge-primary">{{ event.get_event_type_display }}</span>
                                    </td>
                                </tr>
                                <tr>
                                    <th>Status:</th>
                                    <td>
                                        {% if event.status == 'upcoming' %}
                                            <span class="badge badge-info">{{ event.get_status_display }}</span>
                                        {% elif event.status == 'current' %}
                                            <span class="badge badge-success">{{ event.get_status_display }}</span>
                                        {% elif event.status == 'completed' %}
                                            <span class="badge badge-secondary">{{ event.get_status_display }}</span>
                                        {% else %}
                                            <span class="badge badge-danger">{{ event.get_status_display }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Start Date:</th>
                                    <td>{{ event.start_date|date:"l, F d, Y" }}</td>
                                </tr>
                                <tr>
                                    <th>End Date:</th>
                                    <td>{{ event.end_date|date:"l, F d, Y" }}</td>
                                </tr>
                                <tr>
                                    <th>Location:</th>
                                    <td>{{ event.location|default:"-" }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <th width="40%">Total Stations:</th>
                                    <td>{{ event.total_stations }}</td>
                                </tr>
                                <tr>
                                    <th>Expected Attendants:</th>
                                    <td>{{ event.expected_attendants|floatformat:0 }}</td>
                                </tr>
                                <tr>
                                    <th>Created:</th>
                                    <td>{{ event.created_at|date:"M d, Y" }}</td>
                                </tr>
                                <tr>
                                    <th>Last Updated:</th>
                                    <td>{{ event.updated_at|date:"M d, Y" }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    {% if event.description %}
                    <div class="mt-3">
                        <h6>Description:</h6>
                        <p>{{ event.description|linebreaks }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Assignment Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h3 class="text-primary">{{ stats.total_assignments }}</h3>
                            <small class="text-muted">Total Assignments</small>
                        </div>
                        <div class="col-6">
                            <h3 class="text-success">{{ stats.unique_attendants }}</h3>
                            <small class="text-muted">Unique Attendants</small>
                        </div>
                    </div>
                    <hr>
                    <div class="row text-center">
                        <div class="col-12">
                            <h3 class="text-info">{{ stats.positions_filled }}</h3>
                            <small class="text-muted">Positions Filled</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Assignments by Position</h5>
                </div>
                <div class="card-body">
                    {% if assignments_by_position %}
                    <div class="accordion" id="assignmentAccordion">
                        {% for position, position_assignments in assignments_by_position.items %}
                        <div class="card">
                            <div class="card-header" id="heading{{ forloop.counter }}">
                                <h6 class="mb-0">
                                    <button class="btn btn-link" type="button" data-toggle="collapse" 
                                            data-target="#collapse{{ forloop.counter }}" aria-expanded="true" 
                                            aria-controls="collapse{{ forloop.counter }}">
                                        {{ position }} ({{ position_assignments|length }} assignments)
                                    </button>
                                </h6>
                            </div>
                            <div id="collapse{{ forloop.counter }}" class="collapse {% if forloop.first %}show{% endif %}" 
                                 aria-labelledby="heading{{ forloop.counter }}" data-parent="#assignmentAccordion">
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Attendant</th>
                                                    <th>Date</th>
                                                    <th>Shift Time</th>
                                                    <th>Notes</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for assignment in position_assignments %}
                                                <tr>
                                                    <td>
                                                        <a href="{% url 'scheduler:attendant_detail' assignment.attendant.id %}">
                                                            {{ assignment.attendant.get_full_name }}
                                                        </a>
                                                    </td>
                                                    <td>{{ assignment.shift_start|date:"M d, Y" }}</td>
                                                    <td>
                                                        {{ assignment.shift_start|time:"g:i A" }} - 
                                                        {{ assignment.shift_end|time:"g:i A" }}
                                                    </td>
                                                    <td>{{ assignment.notes|default:"-" }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No assignments found for this event.</p>
                        {% if user.role == 'admin' or user.role == 'overseer' %}
                        <a href="#" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Create First Assignment
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
