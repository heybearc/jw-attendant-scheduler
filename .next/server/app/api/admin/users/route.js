"use strict";(()=>{var e={};e.id=2628,e.ids=[2628],e.modules={3524:e=>{e.exports=require("@prisma/client")},399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4770:e=>{e.exports=require("crypto")},8838:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>x,patchFetch:()=>N,requestAsyncStorage:()=>h,routeModule:()=>v,serverHooks:()=>A,staticGenerationAsyncStorage:()=>R});var r={};s.r(r),s.d(r,{GET:()=>p,POST:()=>m});var n=s(9303),a=s(8716),i=s(670),o=s(7070),u=s(3524),l=s(4770),d=s.n(l);let c=new u.PrismaClient;async function p(e){try{let{searchParams:t}=new URL(e.url),s=parseInt(t.get("page")||"1"),r=parseInt(t.get("limit")||"10"),n=t.get("search")||"",a=t.get("role")||"",i=t.get("isActive"),u=(s-1)*r,l={};n&&(l.OR=[{firstName:{contains:n,mode:"insensitive"}},{lastName:{contains:n,mode:"insensitive"}},{email:{contains:n,mode:"insensitive"}}]),a&&(l.role=a),null!=i&&(l.isActive="true"===i);let[d,p]=await Promise.all([c.users.findMany({where:l,select:{id:!0,email:!0,firstName:!0,lastName:!0,role:!0,isActive:!0,lastLogin:!0,createdAt:!0,phone:!0,inviteToken:!0,inviteExpiry:!0},orderBy:{createdAt:"desc"},skip:u,take:r}),c.users.count({where:l})]);return o.NextResponse.json({users:d,pagination:{page:s,limit:r,total:p,pages:Math.ceil(p/r)}})}catch(e){return console.error("Failed to fetch users:",e),o.NextResponse.json({error:"Failed to fetch users"},{status:500})}}async function m(e){try{let{email:t,firstName:r,lastName:n,role:a,phone:i,sendInvite:u=!0}=await e.json();if(!t||!r||!n||!a)return o.NextResponse.json({error:"Missing required fields"},{status:400});if(!["ADMIN","OVERSEER","ASSISTANT_OVERSEER","KEYMAN","ATTENDANT"].includes(a))return o.NextResponse.json({error:"Invalid role"},{status:400});if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t))return o.NextResponse.json({error:"Invalid email format"},{status:400});if(await c.users.findUnique({where:{email:t}}))return o.NextResponse.json({error:"User already exists"},{status:400});let l=null,p=null;u&&(l=d().randomBytes(32).toString("hex"),p=new Date(Date.now()+6048e5));let m=await c.users.create({data:{id:d().randomUUID(),email:t,firstName:r,lastName:n,phone:i||null,role:a,passwordHash:null,isActive:!0,inviteToken:l,inviteExpiry:p,createdAt:new Date,updatedAt:new Date},select:{id:!0,email:!0,firstName:!0,lastName:!0,phone:!0,role:!0,isActive:!0,inviteToken:!0,inviteExpiry:!0,createdAt:!0}}),{EmailService:v}=await s.e(2323).then(s.bind(s,2323));return await v.sendInvitationEmail(t,`${r} ${n}`,l)||console.warn(`[USER_CREATION] Failed to send invitation email to ${t}`),console.log(`[USER_CREATION] Invitation token generated: ${l}`),console.log(`[USER_CREATION] Invitation URL: ${process.env.NEXT_PUBLIC_BASE_URL||"http://localhost:3001"}/auth/accept-invite?token=${l}`),o.NextResponse.json(m,{status:201})}catch(e){return console.error("Failed to create user:",e),o.NextResponse.json({error:"Failed to create user"},{status:500})}}let v=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/admin/users/route",pathname:"/api/admin/users",filename:"route",bundlePath:"app/api/admin/users/route"},resolvedPagePath:"/Users/cory/Documents/Cloudy-Work/applications/jw-attendant-scheduler/app/api/admin/users/route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:h,staticGenerationAsyncStorage:R,serverHooks:A}=v,x="/api/admin/users/route";function N(){return(0,i.patchFetch)({serverHooks:A,staticGenerationAsyncStorage:R})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[9276,5972],()=>s(8838));module.exports=r})();