{% extends 'scheduler/base.html' %}
{% load static %}

{% block title %}Count Reports - {{ event.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'event_list' %}">Events</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'event_detail' event.id %}">{{ event.name }}</a></li>
                    <li class="breadcrumb-item active">Count Reports</li>
                </ol>
            </nav>
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="bi bi-graph-up"></i> Count Reports</h2>
                <div>
                    <a href="{% url 'event_detail' event.id %}" class="btn btn-outline-secondary me-2">
                        <i class="bi bi-arrow-left"></i> Back to Event
                    </a>
                    <a href="{% url 'count_entry' event.id %}" class="btn btn-primary">
                        <i class="bi bi-pencil-square"></i> Enter Counts
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Count Reports -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-clipboard-data"></i> Count Summary</h5>
                </div>
                <div class="card-body">
                    {% if count_sessions %}
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="chart-container" style="position: relative; height:300px;">
                                    <canvas id="countChart"></canvas>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>Position</th>
                                        {% for session in count_sessions %}
                                        <th>{{ session.session_name }}<br>
                                            <small class="text-muted">{{ session.count_time|date:"m/d g:i A" }}</small>
                                        </th>
                                        {% endfor %}
                                        <th>Average</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for position_data in report_data %}
                                    <tr>
                                        <td>
                                            <strong>{{ position_data.position.position_number }}</strong>
                                            {% if position_data.position.position_name %}
                                            <br><small>{{ position_data.position.position_name }}</small>
                                            {% endif %}
                                        </td>
                                        
                                        {% for count_data in position_data.counts %}
                                        <td class="{% if count_data.count is None %}table-warning{% endif %}">
                                            {% if count_data.count is not None %}
                                            {{ count_data.count }}
                                            {% if count_data.notes %}
                                            <i class="bi bi-info-circle text-info" data-bs-toggle="tooltip" title="{{ count_data.notes }}"></i>
                                            {% endif %}
                                            {% else %}
                                            <span class="text-muted">—</span>
                                            {% endif %}
                                        </td>
                                        {% endfor %}
                                        
                                        <td>
                                            {% with counts=position_data.counts|dictsort:"count" %}
                                            {% if counts %}
                                            {% with valid_counts=counts|rejectattr:"count"|length %}
                                            {% if valid_counts > 0 %}
                                            {{ position_data.counts|map:"count"|sum|floatformat:1 }}
                                            {% else %}
                                            <span class="text-muted">—</span>
                                            {% endif %}
                                            {% endwith %}
                                            {% else %}
                                            <span class="text-muted">—</span>
                                            {% endif %}
                                            {% endwith %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-dark">
                                    <tr>
                                        <th>Total</th>
                                        {% for total in total_counts %}
                                        <th>{{ total }}</th>
                                        {% endfor %}
                                        <th>
                                            {% if total_counts %}
                                            {{ total_counts|sum|floatformat:1 }}
                                            {% else %}
                                            0
                                            {% endif %}
                                        </th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> No count sessions have been created for this event yet.
                        </div>
                        <div class="text-center py-4">
                            <a href="{% url 'event_detail' event.id %}#count-times" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> Create Count Session
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
{% if count_sessions %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });
        
        // Create count chart
        var ctx = document.getElementById('countChart').getContext('2d');
        var countChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [
                    {% for session in count_sessions %}
                    '{{ session.session_name }} ({{ session.count_time|date:"m/d g:i A" }})'{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ],
                datasets: [{
                    label: 'Total Attendees',
                    data: [
                        {% for total in total_counts %}
                        {{ total }}{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ],
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    tension: 0.1,
                    pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                    pointRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Attendee Count'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Count Sessions'
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Attendance Trend',
                        font: {
                            size: 16
                        }
                    },
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    });
</script>
{% endif %}
{% endblock %}
{% endblock %}
