{% extends 'scheduler/base.html' %}
{% load static %}

{% block title %}Count Entry - {{ count_session.session_name }} - {{ event.name }}{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-md-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'event_list' %}">Events</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'event_detail' event.id %}">{{ event.name }}</a></li>
                    <li class="breadcrumb-item active">Count Entry</li>
                </ol>
            </nav>
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="bi bi-clipboard-data"></i> Count Entry</h2>
                <div>
                    <a href="{% url 'event_detail' event.id %}" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to Event
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Count Session Selection -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-clock"></i> Count Session</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h4>{{ count_session.session_name }}</h4>
                            <p class="text-muted">
                                <i class="bi bi-calendar-event"></i> {{ count_session.count_time|date:"F j, Y" }} at {{ count_session.count_time|date:"g:i A" }}
                            </p>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="dropdown">
                                <button class="btn btn-outline-primary dropdown-toggle" type="button" id="sessionDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    Change Session
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="sessionDropdown">
                                    {% for session in event.count_sessions.all %}
                                    <li>
                                        <a class="dropdown-item {% if session.id == count_session.id %}active{% endif %}" 
                                           href="{% url 'count_entry' event.id session.id %}">
                                            {{ session.session_name }} ({{ session.count_time|date:"m/d g:i A" }})
                                        </a>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Count Entry Form -->
    <form method="post" id="countEntryForm">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-people"></i> Position Counts</h5>
                        <div>
                            <span class="badge bg-light text-dark me-2">
                                <i class="bi bi-clipboard-check"></i> Total: <span id="totalCount">0</span>
                            </span>
                            <button type="submit" class="btn btn-light">
                                <i class="bi bi-save"></i> Save Counts
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if position_counts %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th style="width: 10%">Position #</th>
                                        <th style="width: 30%">Position Name</th>
                                        <th style="width: 20%">Count</th>
                                        <th style="width: 40%">Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for position_count in position_counts %}
                                    <tr>
                                        <td>{{ position_count.position.position_number }}</td>
                                        <td>
                                            {{ position_count.position.position_name|default_if_none:"" }}
                                            {% if position_count.position.shifts.count > 0 %}
                                            <span class="badge bg-info">{{ position_count.position.shifts.count }} shifts</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <input type="number" 
                                                   name="count_{{ position_count.id }}" 
                                                   id="count_{{ position_count.id }}" 
                                                   class="form-control count-input" 
                                                   min="0" 
                                                   value="{{ position_count.count|default_if_none:'' }}"
                                                   data-position-id="{{ position_count.position.id }}">
                                        </td>
                                        <td>
                                            <input type="text" 
                                                   name="notes_{{ position_count.id }}" 
                                                   id="notes_{{ position_count.id }}" 
                                                   class="form-control" 
                                                   placeholder="Optional notes"
                                                   value="{{ position_count.notes|default_if_none:'' }}">
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle"></i> No positions have been configured for this event.
                            <a href="{% url 'event_positions' event.id %}" class="alert-link">Configure positions</a> before entering counts.
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-footer">
                        <div class="row">
                            <div class="col-md-6">
                                <button type="button" class="btn btn-outline-secondary" id="clearAllCounts">
                                    <i class="bi bi-x-circle"></i> Clear All
                                </button>
                            </div>
                            <div class="col-md-6 text-end">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-save"></i> Save Counts
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Calculate total count
        function updateTotalCount() {
            let total = 0;
            document.querySelectorAll('.count-input').forEach(function(input) {
                const value = parseInt(input.value) || 0;
                total += value;
            });
            document.getElementById('totalCount').textContent = total;
        }

        // Add event listeners to count inputs
        document.querySelectorAll('.count-input').forEach(function(input) {
            input.addEventListener('change', updateTotalCount);
            input.addEventListener('keyup', updateTotalCount);
        });

        // Initialize total count
        updateTotalCount();

        // Clear all counts
        document.getElementById('clearAllCounts').addEventListener('click', function() {
            if (confirm('Are you sure you want to clear all counts? This cannot be undone.')) {
                document.querySelectorAll('.count-input').forEach(function(input) {
                    input.value = '';
                });
                updateTotalCount();
            }
        });

        // Enable keyboard navigation between count inputs
        document.querySelectorAll('.count-input').forEach(function(input, index, inputs) {
            input.addEventListener('keydown', function(e) {
                // Down arrow or Enter moves to next input
                if (e.key === 'ArrowDown' || e.key === 'Enter') {
                    e.preventDefault();
                    if (index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                }
                // Up arrow moves to previous input
                else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (index > 0) {
                        inputs[index - 1].focus();
                    }
                }
            });
        });

        // Auto-save functionality
        let autoSaveTimer;
        const autoSaveDelay = 30000; // 30 seconds

        function setupAutoSave() {
            clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(function() {
                const form = document.getElementById('countEntryForm');
                const formData = new FormData(form);
                
                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const timestamp = new Date().toLocaleTimeString();
                        const saveMessage = document.createElement('div');
                        saveMessage.className = 'alert alert-success alert-dismissible fade show position-fixed bottom-0 end-0 m-3';
                        saveMessage.innerHTML = `
                            <i class="bi bi-check-circle"></i> Auto-saved at ${timestamp}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        `;
                        document.body.appendChild(saveMessage);
                        
                        // Remove the message after 3 seconds
                        setTimeout(() => {
                            saveMessage.remove();
                        }, 3000);
                    }
                });
                
                // Setup next auto-save
                setupAutoSave();
            }, autoSaveDelay);
        }

        // Start auto-save timer
        setupAutoSave();

        // Reset auto-save timer on user input
        document.querySelectorAll('input').forEach(input => {
            input.addEventListener('input', setupAutoSave);
        });
    });
</script>
{% endblock %}
{% endblock %}
